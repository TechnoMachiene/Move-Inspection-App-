<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move-in/Move-out Inspection Automator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
            color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
        }
        h1 {
            font-size: 2.2rem;
            margin-bottom: 24px;
            color: #34495e;
            text-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .container {
            max-width: 1000px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .full {
            grid-column: 1 / -1;
        }
        .card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
        }
        .step-title {
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2980b9;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type="file"] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-input-label {
            display: block;
            padding: 10px 14px;
            background: #ecf0f1;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }
        .selected-file {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #34495e;
            word-break: break-all;
        }
        button {
            padding: 10px 18px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .report-container {
            background: #f9fbfc;
            padding: 18px;
            border-radius: 10px;
            border: 1px solid #e0e6ed;
            max-height: 560px;
            overflow: auto;
        }
        .damage-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }
        .damage-table th, .damage-table td {
            padding: 10px;
            border: 1px solid #e6edf3;
            text-align: left;
            font-size: 0.95rem;
        }
        .damage-table th { background: #ecf4fb; font-weight: 700; }
        .total-due { font-size: 1.15rem; font-weight: 700; color: #c0392b; margin-top: 12px; }

        /* Responsive */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<h1>üè† Move-in/Move-out Inspection Automator</h1>

<div class="container">

    <div class="card">
        <div class="step-title">Upload Move-in Image</div>
        <div class="file-input-wrapper">
            <label class="file-input-label" for="movein">
                <span id="movein-label">Drag & drop or click to select move-in image</span>
            </label>
            <input type="file" id="movein" accept="image/*">
        </div>
        <div id="movein-file" class="selected-file"></div>
    </div>

    <div class="card">
        <div class="step-title">Upload Move-out Image</div>
        <div class="file-input-wrapper">
            <label class="file-input-label" for="moveout">
                <span id="moveout-label">Drag & drop or click to select move-out image</span>
            </label>
            <input type="file" id="moveout" accept="image/*">
        </div>
        <div id="moveout-file" class="selected-file"></div>
    </div>

    <div class="card full" style="display:flex;justify-content:center;align-items:center;">
        <button id="analyzeBtn" onclick="analyze()">üîç Analyze Images</button>
    </div>

    <div class="card full">
        <div class="step-title">Inspection Report</div>
        <div id="reportOutput" class="report-container">No report yet...</div>
    </div>

</div>

<script>
const API_BASE = "http://127.0.0.1:8000"; // Change for production

// Keep current file labels
document.getElementById("movein").addEventListener("change", function() {
    const fileName = this.files[0] ? this.files[0].name : "";
    document.getElementById("movein-label").textContent = fileName || "Drag & drop or click to select move-in image";
    document.getElementById("movein-file").textContent = fileName ? `Selected: ${fileName}` : "";
});

document.getElementById("moveout").addEventListener("change", function() {
    const fileName = this.files[0] ? this.files[0].name : "";
    document.getElementById("moveout-label").textContent = fileName || "Drag & drop or click to select move-out image";
    document.getElementById("moveout-file").textContent = fileName ? `Selected: ${fileName}` : "";
});

function renderReportFromDamages(data) {
    // Builds an accessible table view for the damages JSON
    const container = document.createElement('div');

    // Summary header
    const summary = document.createElement('div');
    summary.innerHTML = `<strong>Inspection Summary</strong><p style="color:#7f8c8d;font-size:0.9rem;margin:4px 0;">Auto-generated damage list and estimated costs</p>`;
    container.appendChild(summary);

    // Table
    const table = document.createElement('table');
    table.className = 'damage-table';
    table.innerHTML = `
        <thead>
            <tr><th>#</th><th>Location</th><th>Category</th><th>Description</th><th>Estimated Cost (USD)</th></tr>
        </thead>
        <tbody></tbody>
    `;

    let tbody = table.querySelector('tbody');
    let total = 0;
    
    if (Array.isArray(data.damages) && data.damages.length > 0) {
        data.damages.forEach((dmg, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${escapeHtml(dmg.location || '')}</td>
                <td>${escapeHtml(dmg.category || '')}</td>
                <td>${escapeHtml(dmg.description || '')}</td>
                <td>$${Number(dmg.estimated_cost || 0).toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
            total += Number(dmg.estimated_cost) || 0;
        });
    } else {
        // No damages found
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" style="text-align:center;color:#7f8c8d;font-style:italic;">No damages detected</td>`;
        tbody.appendChild(tr);
    }

    container.appendChild(table);

    const totalP = document.createElement('div');
    totalP.className = 'total-due';
    totalP.textContent = `Total Estimated Cost: $${(data.totalEstimatedCost !== undefined ? Number(data.totalEstimatedCost) : total).toFixed(2)}`;
    container.appendChild(totalP);

    // Attach to reportOutput
    const out = document.getElementById('reportOutput');
    out.innerHTML = '';
    out.appendChild(container);
}

function escapeHtml(text) {
    return (text + '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function formatReport(reportData) {
    try {
        let parsedData;
        
        // Handle nested response structure like { "n8n_response_text": "{...}" }
        if (reportData.n8n_response_text) {
            parsedData = JSON.parse(reportData.n8n_response_text);
        } else if (reportData.n8n_response_json) {
            parsedData = typeof reportData.n8n_response_json === 'string' ? 
                JSON.parse(reportData.n8n_response_json) : reportData.n8n_response_json;
        } else if (reportData.n8n_response) {
            parsedData = typeof reportData.n8n_response === 'string' ? 
                JSON.parse(reportData.n8n_response) : reportData.n8n_response;
        } else {
            parsedData = reportData;
        }
        
        // Check if it has the expected damages structure
        if (parsedData && (Array.isArray(parsedData.damages) || parsedData.damages === undefined)) {
            renderReportFromDamages(parsedData);
            return;
        }

        // Fallback: display as formatted JSON
        document.getElementById('reportOutput').innerHTML = `<pre>${JSON.stringify(parsedData, null, 2)}</pre>`;
    } catch (e) {
        console.warn('Could not parse response, rendering raw:', e);
        document.getElementById('reportOutput').innerHTML = `<pre>${JSON.stringify(reportData, null, 2)}</pre>`;
    }
}

async function analyze() {
    const moveinInput = document.getElementById("movein");
    const moveoutInput = document.getElementById("moveout");
    const analyzeBtn = document.getElementById("analyzeBtn");

    if (!moveinInput.files.length || !moveoutInput.files.length) {
        alert("Please select both move-in and move-out images.");
        return;
    }

    analyzeBtn.disabled = true;
    document.getElementById("reportOutput").innerHTML = '<p style="color:#7f8c8d;">Analyzing images... Please wait.</p>';

    const formData = new FormData();
    formData.append("movein", moveinInput.files[0]);
    formData.append("moveout", moveoutInput.files[0]);

    try {
        const res = await fetch(`${API_BASE}/analyze`, {
            method: "POST",
            body: formData
        });
        const data = await res.json();
        if (res.ok) {
            formatReport(data);
        } else {
            alert(`Error: ${data.detail || "Analysis failed"}`);
            document.getElementById("reportOutput").innerHTML = `<p style="color: red;">Error: ${data.detail || "Analysis failed"}</p>`;
        }
    } catch (err) {
        alert(`Request failed: ${err.message}`);
        document.getElementById("reportOutput").innerHTML = `<p style="color: red;">Request failed: ${err.message}</p>`;
    } finally {
        analyzeBtn.disabled = false;
    }
}

function loadSample() {
    // Function removed - no longer needed
}
</script>

</body>
</html>